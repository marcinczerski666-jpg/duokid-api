<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>DuoKid</title>

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: radial-gradient(circle at center, #001533, #000a1a);
        color: white;
        text-align: center;
    }

    .container {
        margin: 40px auto;
        max-width: 450px;
        padding: 20px;
        background: white;
        color: black;
        border-radius: 20px;
        box-shadow: 0 0 40px rgba(120, 80, 255, 0.6);
    }

    #eye {
        width: 160px;
        height: 160px;
        margin: 0 auto 20px;
        border-radius: 50%;
        background: radial-gradient(circle at 40% 40%, #ffffff, #a88bff, #6a40ff);
        box-shadow: 0 0 40px rgba(140, 80, 255, 0.7);
        cursor: pointer;
        transition: 0.3s;
    }

    #eye.active {
        box-shadow: 0 0 60px rgba(0, 255, 140, 1);
        background: radial-gradient(circle at 40% 40%, #cfffde, #44ff9a, #00c46a);
    }

    #name {
        font-size: 28px;
        font-weight: bold;
        margin-bottom: 15px;
    }

    #chat {
        background: #e9eefc;
        padding: 15px;
        border-radius: 15px;
        height: 260px;
        overflow-y: auto;
        text-align: left;
        font-size: 16px;
    }

    .duo { color: #0047ff; margin-bottom: 10px; }
    .you { color: #008a2e; margin-bottom: 10px; }

    #hint {
        margin-top: 20px;
        font-size: 15px;
        opacity: 0.8;
    }
</style>
</head>

<body>

<div class="container">
    <div id="eye"></div>
    <div id="name">DUOKID</div>

    <div id="chat"></div>

    <div id="hint">Tap the eye and speak to DuoKid.</div>
</div>

<script>
const chat = document.getElementById("chat");
const eye = document.getElementById("eye");

// Add message to chat
function addMessage(who, text) {
    const p = document.createElement("div");
    p.className = who;
    p.textContent = (who === "duo" ? "Duokid: " : "You: ") + text;
    chat.appendChild(p);
    chat.scrollTop = chat.scrollHeight;
}

// Welcome message
addMessage("duo", "Hi! I'm here. Tap the eye and talk to me.");


// Text-to-Speech
function speak(text) {
    const msg = new SpeechSynthesisUtterance(text);
    msg.lang = "en-US";
    speechSynthesis.speak(msg);
}


// Send text to backend
async function askDuokid(userText) {
    addMessage("duo", "Thinking…");

    try {
        const res = await fetch("/api/duokid", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userText })
        });

        const data = await res.json();

        if (data.reply) {
            addMessage("duo", data.reply);
            speak(data.reply);
        } else {
            addMessage("duo", "I cannot answer right now.");
        }

    } catch (err) {
        addMessage("duo", "Connection error.");
    }
}


// Speech Recognition
let listening = false;
let recognition;

if ("webkitSpeechRecognition" in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = "en-US";
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onstart = () => {
        listening = true;
        eye.classList.add("active");
    };

    recognition.onend = () => {
        listening = false;
        eye.classList.remove("active");
    };

    recognition.onerror = () => {
        addMessage("duo", "Microphone error.");
        listening = false;
        eye.classList.remove("active");
    };

    recognition.onresult = async (event) => {
        const text = event.results[0][0].transcript;
        addMessage("you", text);
        await askDuokid(text);
    };
} else {
    addMessage("duo", "Your browser does not support voice input.");
}


// Eye tap → start/stop listening
eye.addEventListener("click", () => {
    if (!recognition) return;
    if (!listening) recognition.start();
    else recognition.stop();
});
</script>

</body>
</html>